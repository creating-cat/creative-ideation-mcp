# アイデアカテゴリー生成MCPサーバー - 概要設計書

## プロジェクト概要

### 目的
GPGGプロジェクトの核心機能を抽出し、特定のトピックやコンテキストに対して多角的な視点やアイデアを提供するためのカテゴリーと選択肢を生成するMCPサーバーを実装する。主にAIが創造的思考を行う際の支援ツールとして機能させる。

### 背景
- AIは特定のトピック（例：ボードゲーム設計）について考える際、多角的な視点が必要
- 人間の専門家は自然と多様な観点から問題を考えられるが、AIはそれを明示的に提供されると有益
- カテゴリーと選択肢の形で思考の枠組みを提供することで、AIの創造的思考を支援できる

### スコープ

#### 含まれる機能
- トピック/コンテキスト分析
- 関連カテゴリーの生成
- 各カテゴリーの選択肢生成
- 日本語対応
- カテゴリー数と選択肢数の制御
- エラーハンドリングとログ機能

#### 含まれない機能
- プロンプト生成機能（カテゴリーと選択肢の提供のみ）
- 詳細/高速モードの切り替え（単一の処理モードのみ）
- お気に入り機能
- 画像生成機能
- Web UI

## 将来の拡張機能案

### ランダムチョイスモード
**目的**: AIの選択パターンの類似性を回避し、オリジナリティを向上させる

**機能概要**:
- 通常より多くの選択肢を生成（例: 100個）
- その中からランダムに指定数をサンプリング（例: 10個）
- 意外な組み合わせによる創造性の促進

**パラメータ案**:
```typescript
{
  random_mode?: boolean;              // ランダムモード有効化
  random_sample_size?: number;        // ランダム選択数
  exclude_common?: boolean;           // 一般的な選択肢の除外
  weighted_random?: boolean;          // 使用頻度による重み付け
}
```

**期待効果**:
- AIの選択パターンの多様化
- 創造的な発想の促進
- オリジナリティの向上

## アーキテクチャ概要

### システム構成
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   MCP Client    │    │   MCP Server     │    │  Gemini API     │
│   (Kiro等)     │◄──►│  (本プロジェクト)  │◄──►│                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 主要コンポーネント
1. **MCPサーバー本体** (`src/index.ts`)
   - MCP通信の管理
   - ツールの登録と実行

2. **トピック分析モジュール** (`src/modules/topicAnalyzer.ts`)
   - 入力されたトピック/コンテキストの分析
   - 関連する思考領域の特定

3. **カテゴリー生成モジュール** (`src/modules/categoryGenerator.ts`)
   - トピックに関連するカテゴリーの生成
   - 各カテゴリーの説明の生成

4. **選択肢生成モジュール** (`src/modules/optionGenerator.ts`)
   - カテゴリー別選択肢の生成
   - 日本語対応

5. **統合ツール** (`src/tools/generateIdeaCategories.ts`)
   - 上記モジュールを統合した単一ツール

### 技術スタック
- **言語**: TypeScript
- **MCPフレームワーク**: @modelcontextprotocol/sdk
- **AIサービス**: Google Gemini API (@google/genai)
- **バリデーション**: Zod
- **設定管理**: dotenv
- **ビルドツール**: TypeScript Compiler

### 重要な実装機能
- **レート制限管理**: 5秒間隔の自動API呼び出し制御
- **JSON自動修正**: パースエラー時のAIによる自動修正
- **包括的リトライ**: 最大3回の自動リトライ機能
- **APIレスポンス前処理**: マークダウン記法の自動除去

## データフロー

### 基本フロー
1. **入力**: クライアントが専門家役割と対象テーマを送信
2. **コンテキスト構築**: 専門家の視点でのカテゴリー生成プロンプトを構築
3. **カテゴリー生成**: 専門家の視点から関連するカテゴリーを生成
4. **選択肢生成**: 各カテゴリーの選択肢を生成
5. **出力**: 構造化されたJSONデータを返却

### データ構造例
```json
{
  "expert_role": "ゲームデザイナー",
  "target_subject": "オリジナルボードゲーム",
  "categories": [
    {
      "name": "ゲームメカニクス",
      "description": "ゲームの基本的な動作や仕組み",
      "options": [
        "ワーカープレイスメント",
        "デッキ構築",
        "エリアコントロール",
        ...
      ]
    },
    {
      "name": "テーマ",
      "description": "ゲームの世界観や背景設定",
      "options": [
        "宇宙探検",
        "中世ファンタジー",
        "近未来ディストピア",
        ...
      ]
    }
  ]
}
```

## 品質要件

### パフォーマンス
- **レスポンス時間**: 2-3分（レート制限により）
- **API呼び出し間隔**: 5秒間隔（Gemini APIレート制限対応）
- **推定API呼び出し回数**: 約31回 (1 + 15×2)
- **同時リクエスト**: 1件のみ（MCPサーバーの性質上）
- **カテゴリー数**: デフォルト15件（最大30件）
- **選択肢数**: デフォルト20件/カテゴリー（最大50件）

### 処理制約
- **MCPプログレス表示**: 不可（標準入出力通信のため）
- **並行処理**: 不可（レート制限のため順次処理）
- **処理時間通知**: 開始時にユーザーへ所要時間を通知

### 可用性
- API制限に対する適切なエラーハンドリング
- ネットワーク障害時の再試行機能
- 設定不備時の明確なエラーメッセージ

### セキュリティ
- APIキーの安全な管理
- 入力データの適切なサニタイズ
- ログでの機密情報の除外

## 運用要件

### 設定
- 環境変数による設定管理
- MCP標準設定との互換性
- 開発・本番環境の切り分け

### ログ
- 構造化ログの出力
- エラー詳細の記録
- パフォーマンス指標の記録

### デプロイ
- npm パッケージとしての配布
- Docker対応（オプション）
- CI/CDパイプライン