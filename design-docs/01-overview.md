# コンテキストオプション生成MCPサーバー - 概要設計書

## プロジェクト名
**gemini-context-options-mcp-server**

## プロジェクト概要

### 目的
GPGGプロジェクトの核心機能を抽出し、特定のトピックやコンテキストに対して多角的な視点やアイデアを提供するためのカテゴリーと選択肢を生成するMCPサーバーを実装する。主にAIが創造的思考を行う際の支援ツールとして機能させる。

### 背景
- AIは特定のトピック（例：ボードゲーム設計）について考える際、多角的な視点が必要
- 人間の専門家は自然と多様な観点から問題を考えられるが、AIはそれを明示的に提供されると有益
- カテゴリーと選択肢の形で思考の枠組みを提供することで、AIの創造的思考を支援できる

### スコープ

#### 含まれる機能
- トピック/コンテキスト分析
- 関連カテゴリーの生成
- 各カテゴリーの選択肢生成
- 日本語対応
- カテゴリー数と選択肢数の制御
- エラーハンドリングとログ機能

#### 含まれない機能
- プロンプト生成機能（カテゴリーと選択肢の提供のみ）
- 詳細/高速モードの切り替え（単一の処理モードのみ）
- お気に入り機能
- 画像生成機能
- Web UI

## 拡張機能: ランダムチョイスモード

### 概要
**目的**: AIの選択パターンの類似性を回避し、オリジナリティを向上させる

### 2つの主要用途
1. **網羅的探索モード**: より多くの選択肢を確認したい場合
2. **ランダムサンプリングモード**: 多くの選択肢の中からランダムに絞った選択肢を得たい場合

### 入力スキーマ設計
```typescript
export const generateIdeaCategoriesSchema = z.object({
  expert_role: z.string().min(1).describe('専門家役割'),
  target_subject: z.string().min(1).describe('対象テーマ'),
  
  // 生成数の制御（統一された命名）
  target_categories: z.number()
    .int()
    .min(10)
    .max(30)
    .optional()
    .default(20)
    .describe('生成するカテゴリ数の目安'),
  
  target_options_per_category: z.number()
    .int()
    .min(10)
    .max(200)
    .optional()
    .default(20)
    .describe('1カテゴリあたりの選択肢生成数の目安（カテゴリの性質により自動調整）'),
  
  // ランダム化制御
  randomize_selection: z.boolean()
    .optional()
    .default(false)
    .describe('選択肢をランダムに選ぶかどうか'),
  
  random_sample_size: z.number()
    .int()
    .min(5)
    .max(200)  // target_options_per_categoryの最大値と同じ
    .optional()
    .default(10)
    .describe('ランダム選択時の最大出力数（実際の選択肢数がこれより少ない場合は全て出力）'),
  
  domain_context: z.string().optional().describe('追加のドメイン固有コンテキスト')
});
```

### 動作パターン
1. **通常モード**: `target_options_per_category`個生成 → 全て返却
2. **網羅的探索**: `target_options_per_category`を大きく設定 → 全て返却
3. **ランダムサンプリング**: `target_options_per_category`個生成 → `random_sample_size`個をランダム選択

### 期待効果
- AIの選択パターンの多様化
- 創造的な発想の促進
- オリジナリティの向上
- 意外な組み合わせによる新しいアイデアの発見

## アーキテクチャ概要

### システム構成
```
┌─────────────────┐    ┌──────────────────────────────┐    ┌─────────────────┐
│   MCP Client    │    │   MCP Server                 │    │  Gemini API     │
│   (Kiro等)     │◄──►│  (gemini-context-options-    │◄──►│                 │
│                 │    │   mcp-server)                │    │                 │
└─────────────────┘    └──────────────────────────────┘    └─────────────────┘
```

### 主要コンポーネント
1. **MCPサーバー本体** (`src/index.ts`)
   - MCP通信の管理
   - ツールの登録と実行

2. **トピック分析モジュール** (`src/modules/topicAnalyzer.ts`)
   - 入力されたトピック/コンテキストの分析
   - 関連する思考領域の特定

3. **カテゴリー生成モジュール** (`src/modules/categoryGenerator.ts`)
   - トピックに関連するカテゴリーの生成
   - 各カテゴリーの説明の生成

4. **選択肢生成モジュール** (`src/modules/optionGenerator.ts`)
   - カテゴリー別選択肢の生成
   - 日本語対応

5. **統合ツール** (`src/tools/generateIdeaCategories.ts`)
   - 上記モジュールを統合した単一ツール

### 技術スタック
- **言語**: TypeScript
- **MCPフレームワーク**: @modelcontextprotocol/sdk
- **AIサービス**: Google Gemini API (@google/genai)
- **バリデーション**: Zod
- **設定管理**: dotenv
- **ビルドツール**: TypeScript Compiler
- **パッケージ名**: gemini-context-options-mcp-server

### 重要な実装機能
- **レート制限管理**: 5秒間隔の自動API呼び出し制御
- **JSON自動修正**: パースエラー時のAIによる自動修正
- **包括的リトライ**: 最大3回の自動リトライ機能
- **APIレスポンス前処理**: マークダウン記法の自動除去
- **ランダムサンプリング**: メモリ内でのシャッフル・選択処理
- **統一された命名規則**: `target_*`形式でのパラメータ命名

## データフロー

### 基本フロー
1. **入力**: クライアントが専門家役割と対象テーマを送信
2. **コンテキスト構築**: 専門家の視点でのカテゴリー生成プロンプトを構築
3. **カテゴリー生成**: 専門家の視点から関連するカテゴリーを生成
4. **選択肢生成**: 各カテゴリーの選択肢を生成
5. **出力**: 構造化されたJSONデータを返却

### 使用例

#### 通常モード（デフォルト）
```json
{
  "expert_role": "ゲームデザイナー",
  "target_subject": "オリジナルボードゲーム"
}
```
→ 20カテゴリ、各20選択肢を生成して全て返却

#### 網羅的探索モード
```json
{
  "expert_role": "ゲームデザイナー",
  "target_subject": "オリジナルボードゲーム",
  "target_categories": 25,
  "target_options_per_category": 100
}
```
→ 25カテゴリ、各100選択肢を生成して全て返却

#### ランダムサンプリングモード
```json
{
  "expert_role": "ゲームデザイナー",
  "target_subject": "オリジナルボードゲーム",
  "target_categories": 15,
  "target_options_per_category": 80,
  "randomize_selection": true,
  "random_sample_size": 12
}
```
→ 15カテゴリ、各80選択肢を生成してランダムに12個選択して返却

### データ構造例
```json
{
  "success": true,
  "data": {
    "expert_role": "ゲームデザイナー",
    "target_subject": "オリジナルボードゲーム",
    "categories": [
      {
        "name": "ゲームメカニクス",
        "description": "ゲームの基本的な動作や仕組み",
        "options": [
          "ワーカープレイスメント",
          "デッキ構築",
          "エリアコントロール",
          "..."
        ]
      },
      {
        "name": "テーマ",
        "description": "ゲームの世界観や背景設定",
        "options": [
          "宇宙探検",
          "中世ファンタジー",
          "近未来ディストピア",
          "..."
        ]
      }
    ]
  }
}
```

## 品質要件

### パフォーマンス
- **レスポンス時間**: 2-3分（レート制限により）
- **API呼び出し間隔**: 5秒間隔（Gemini APIレート制限対応）
- **推定API呼び出し回数**: 約41回 (1 + 20×2) ※デフォルト設定時
- **同時リクエスト**: 1件のみ（MCPサーバーの性質上）
- **カテゴリー数**: デフォルト20件（最大30件）
- **選択肢数**: デフォルト20件/カテゴリー（最大200件）
- **ランダムサンプリング**: 生成後にメモリ内で処理（追加API呼び出しなし）

### 処理制約
- **MCPプログレス表示**: 不可（標準入出力通信のため）
- **並行処理**: 不可（レート制限のため順次処理）
- **処理時間通知**: 開始時にユーザーへ所要時間を通知

### 可用性
- API制限に対する適切なエラーハンドリング
- ネットワーク障害時の再試行機能
- 設定不備時の明確なエラーメッセージ

### セキュリティ
- APIキーの安全な管理
- 入力データの適切なサニタイズ
- ログでの機密情報の除外

## 運用要件

### 設定
- 環境変数による設定管理
- MCP標準設定との互換性
- 開発・本番環境の切り分け

### ログ
- 構造化ログの出力
- エラー詳細の記録
- パフォーマンス指標の記録

### デプロイ
- npm パッケージとしての配布
- Docker対応（オプション）
- CI/CDパイプライン
##
 実装における命名規則の統一

### パラメータ命名
- **統一形式**: `target_*` 形式を採用
- **理由**: プロンプト内で「〜程度を目安」として使用されるため
- **例**: `target_categories`, `target_options_per_category`

### プロンプト変数命名
- **旧**: `{{MAX_CATEGORIES}}`, `{{MAX_OPTIONS}}`
- **新**: `{{TARGET_CATEGORIES}}`, `{{TARGET_OPTIONS}}`
- **統一性**: パラメータ名とプロンプト変数名の一致

### 実装変更箇所
1. **入力スキーマ**: `generateIdeaCategoriesSchema`の更新
2. **カテゴリ生成**: `categoryGenerator.ts`のプロンプト変数名
3. **選択肢生成**: `optionGenerator.ts`のプロンプト変数名とランダム選択ロジック追加
4. **メインツール**: `generateIdeaCategories.ts`のパラメータ処理

### GPGGプロンプトからの重要な改良点

#### 選択肢数の柔軟性
- 原則として指定数を目安に生成
- **カテゴリの性質上、選択肢の数が自然と限定される場合**（例：「曜日」なら7つ、「評価（5段階）」なら5つ）は、無理に目標数を目指さず、考えられる全てのバリエーションを網羅

#### プロンプト要素としての自然性
- 単なるキーワードではなく、**プロンプト内で意味を成す自然な表現**を重視
- AIへの入力として機能する文の一部となることを意識

#### 多様性の具体的指示
- 同じような表現の回避
- **ポジティブ／ネガティブや多様な軸**（属性、形式、スタイル、性質など）での分散

#### ユーザーリクエストの活用
- 大元のユーザーリクエストにカテゴリ固有の情報が含まれている場合の反映
- カテゴリ生成と選択肢生成の両段階での活用

#### ランダムサンプリングの改良
- `random_sample_size`は**最大選択数**として機能
- 実際の選択肢数がそれより少ない場合は全て出力
- 無理な水増しを避ける自然な動作

### 後方互換性
- 新しいパラメータはすべてオプション
- デフォルト値により既存の動作を維持
- `randomize_selection: false`がデフォルトで通常動作
## 
プロンプト設計の改良

### GPGGからの重要な学習点

#### 1. 選択肢生成の柔軟性
元のGPGGプロンプトから以下の重要な指示を取り込み：

```
- 原則として、{{TARGET_OPTIONS}}個程度を目安に生成してください。
- ただし、カテゴリの性質上、選択肢の数が自然と限定される場合（例：カテゴリが「曜日」であれば選択肢は7つ、「評価（5段階）」であれば5つなど）は、無理に{{TARGET_OPTIONS}}個を目指す必要はありません。その場合は、考えられる全てのバリエーションを網羅するようにしてください。
```

#### 2. プロンプト要素としての品質
```
- これらの選択肢は、AIに対してプロンプトとして入力される文の一部になります。
- したがって、単なるキーワードではなく、プロンプト内で意味を成し、「{{TARGET_SUBJECT}}」の生成に寄与するような自然な表現を意識してください。
```

#### 3. 多様性の確保
```
- 同じような表現ばかりにならないようにしてください。
- ポジティブ／ネガティブや多様な軸（属性、形式、スタイル、性質など）で分散してください。
```

#### 4. ユーザーリクエストの統合
```
# 大元のユーザーリクエスト
以下の内容に{{CATEGORY_NAME}}についての情報が含まれている場合は、それを取り入れて反映してください。

====大元のユーザーリクエスト(ここから)====
{{USER_REQUEST}}
====大元のユーザーリクエスト(ここまで)====
```

### 改良されたプロンプト構造

#### カテゴリ生成プロンプト
- `{{TARGET_CATEGORIES}}`変数への統一
- ユーザーリクエストの文脈反映
- 専門家視点の強化

#### 選択肢生成プロンプト
- `{{TARGET_OPTIONS}}`変数への統一
- 自然な選択肢数の調整ロジック
- プロンプト要素としての品質重視
- 多様性確保の具体的指示
- ユーザーリクエストからのカテゴリ固有情報抽出

### 品質向上のポイント

1. **自然な数量調整**: カテゴリの性質に応じた適切な選択肢数
2. **プロンプト品質**: AIへの入力として機能する自然な表現
3. **多様性確保**: 様々な軸での分散による豊富なバリエーション
4. **文脈活用**: ユーザーの初期要望からの関連情報抽出
5. **柔軟性**: 固定的な数値目標ではなく、品質重視のアプローチ